<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Title</title>
  <link rel="stylesheet" th:href="@{/css/procuOneHeader.css}">
</head>
<body>
<!-- 헤더-->
<div th:replace="partials/procuOneHeader :: header"></div>

<form th:action="@{/signup}" method="post">
  <div>
    <h1>회원가입</h1>
    <div>
      <label>이름:</label>
      <input class="addUser" name="memberName" type="text" required>
    </div>
    <div>
      <label>아이디:</label>
      <input class="addUser" name="memberId" type="text" id="memberId" required>
      <button type="button" id="checkIdBtn">ID 중복 확인</button>
      <span id="idCheckResult"></span> <!-- 중복 여부 표시 -->
    </div>
    <div>
      <label>비밀번호:</label>
      <input class="addUser" name="password" type="password" required>
    </div>
    <div>
      <label>비밀번호 확인:</label>
      <input class="addUser" name="password2" type="password" required>
    </div>
    <div>
      <label>이메일</label>
      <input class="addUser" name="email" type="text" placeholder="이메일 아이디" required>
      <input class="addUser" name="emailDirect" id="emailDirect" placeholder="직접 입력" type="text">
      <select name="emailSelect" id="emailSelect">
        <option selected value="none">도메인 선택</option>
        <option value="naver.com">naver.com</option>
        <option value="gamil.com">gamil.com</option>
        <option value="daum.net">daum.net</option>
      </select>
    </div>
    <div>
      <label>핸드폰</label>
      <input class="addUser" name="phone" type="text">
    </div>
    <div>
      <label>부서번호:</label>
      <input class="addUser" name="dno" type="text">
    </div>
    <div>
      <button type="submit">확인</button>
      <button type="reset">취소</button>
    </div>
  </div>
</form>

<script>
  // 아이디 중복 확인 버튼 클릭 시
  document.getElementById("checkIdBtn").addEventListener("click", function() {
    const memberId = document.getElementById("memberId").value;

    if (!memberId) {
      alert("아이디를 입력하세요.");
      return;
    }

    // Ajax 요청으로 중복 아이디 확인
    fetch(`/check-id?memberId=${memberId}`)
            .then(response => response.json())
            .then(data => {
              if (data.exists) {
                document.getElementById("idCheckResult").innerText = "이미 존재하는 아이디입니다.";
                document.getElementById("idCheckResult").style.color = "red";
              } else {
                document.getElementById("idCheckResult").innerText = "사용 가능한 아이디입니다.";
                document.getElementById("idCheckResult").style.color = "green";
              }
            })
            .catch(error => {
              console.error("아이디 중복 확인 오류:", error);
            });
  });

  document.querySelector('form').addEventListener('submit', function(event) {
    event.preventDefault();  // 폼 제출을 막는다

    const memberId = document.querySelector('input[name=memberId]').value;
    const memberName = document.querySelector('input[name=memberName]').value;
    const password = document.querySelector('input[name=password]').value;
    const password2 = document.querySelector('input[name=password2]').value;
    const phone = document.querySelector('input[name=phone]').value;
    const dno = document.querySelector('input[name=dno]').value;
    const email = document.querySelector('input[name=email]').value;  // 이메일 아이디
    const emailDirect = document.querySelector('input[name=emailDirect]').value; // 직접 입력된 도메인
    const emailSelect = document.querySelector('select[name=emailSelect]').value; // 선택된 도메인

    let Useremail = '';

    // 이메일 결합 로직: emailDirect와 emailSelect 둘 중 하나만 사용해야 함
    if (emailDirect && emailSelect !== 'none') {
      // 둘 다 입력될 수 없으므로 경고 메시지 표시
      alert('이메일 아이디와 도메인은 하나만 입력해야 합니다.');
      event.preventDefault();
      return;
    } else if (emailDirect) {
      // emailDirect만 입력된 경우, 이메일 아이디 + 도메인 결합
      Useremail = `${email}@${emailDirect}`;
    } else if (emailSelect !== 'none') {
      // emailSelect만 선택된 경우, email 필드에 입력된 아이디와 결합
      if (!email) {
        alert('이메일 아이디를 입력해주세요.');
        event.preventDefault();
        return;
      }
      Useremail = `${email}@${emailSelect}`;
    } else {
      // emailDirect와 emailSelect가 모두 비어있을 경우
      alert('이메일 아이디 또는 도메인을 선택해주세요.');
      event.preventDefault();
      return;
    }

    // 이메일 형식 검사
    function validateEmail(email) {
      const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return regex.test(email);
    }

    // 이메일 형식 검사
    if (!validateEmail(Useremail)) {
      alert('유효하지 않은 이메일 주소입니다.');
      event.preventDefault();
      return;
    }

    // 필수 입력 확인
    if (!memberId || !password || !password2 || !memberName || !Useremail || !dno || !phone) {
      alert('아이디, 비밀번호, 이름, 이메일, 부서번호, 연락처는 필수 입력 항목입니다.');
      return;
    } else if (password !== password2) {
      alert('비밀번호와 비밀번호 확인이 일치하지 않습니다.');
      event.preventDefault();
      return;
    }

    // **email 필드에 생성된 이메일 주소 값을 설정**
    document.querySelector('input[name="email"]').value = Useremail; // 이메일을 email 필드에 설정

    // 모든 조건을 통과하면 폼 제출
    this.submit();
  });
</script>

</body>
</html>
