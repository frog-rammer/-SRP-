<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" th:href="@{/css/procuOneHeader.css}">
  <link rel="stylesheet" th:href="@{/css/layout.css}">
  <title>자재 출고 관리</title>
  <style>
    /* 페이지네이션 스타일 */
    .pagination {
      display: flex;
      justify-content: center; /* 중앙 정렬 */
      margin-top: 20px;
      font-size: 1rem;
      gap: 5px; /* 버튼 사이 간격 */
    }

    .pagination a {
      display: inline-block;
      padding: 8px 16px;
      background-color: #f4f4f4; /* 기본 배경색 */
      pointer-events: auto; /* 클릭 허용 */
      color: #2c3e50; /* 기본 텍스트 색 */
      text-decoration: none;
      border: 1px solid #ddd;
      border-radius: 5px;
      transition: background-color 0.3s, color 0.3s;
    }

    .pagination a:hover {
      background-color: #32928E; /* 호버 시 배경색 */
      color: white; /* 호버 시 텍스트 색 */
    }

    .pagination a.current {
      background-color: #32928E; /* 현재 페이지 배경색 */
      color: white; /* 현재 페이지 텍스트 색 *
      font-weight: bold; /* 강조 */
    }

    .pagination span {
      display: inline-block;
      padding: 8px 16px;
      color: #999; /* 비활성화된 상태 텍스트 색 */
      border-radius: 5px;
      pointer-events: none; /* 클릭 불가 */
    }

    /* 숨겨진 섹션 초기 스타일 */
    .productionPlanListWrap {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.5s ease-out, opacity 0.5s ease-out;
      opacity: 0;
    }

    /* 섹션이 보이는 상태 */
    .productionPlanListWrap.active {
      max-height: 500px; /* 충분히 큰 값으로 설정 */
      opacity: 1;
    }


    /* 메인 영역 스타일 */
    .layout-main {
      padding: 30px;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      margin-top: 20px;
    }

    .layout-main h1 {
      font-size: 2rem;
      color: #2c3e50;
      margin-bottom: 20px;
      font-weight: bold;
      border-bottom: 2px solid #32928E;
      padding-bottom: 10px;
    }

    .layout-main h2 {
      font-size: 1.5rem;
      color: #2c3e50;
      margin-bottom: 15px;
      font-weight: bold;
    }

    /* 테이블 스타일 */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 30px;
      border-radius: 8px;
      overflow: hidden;
    }

    table th, table td {
      padding: 12px 20px;
      text-align: center;
      font-size: 1rem;
    }

    table th {
      background-color: #32928E;
      color: #fff;
      font-weight: bold;
    }

    table tbody tr:nth-child(even) {
      background-color: #ecf0f1;
    }

    table tbody tr:nth-child(odd) {
      background-color: #fff;
    }

    table tbody tr:hover {
      background-color: #f1c40f;
    }

    table td {
      border-bottom: 1px solid #ddd;
    }

    /* 체크박스 및 버튼 스타일 */
    input[type="checkbox"] {
      transform: scale(1.2);
    }

    /* 버튼 스타일 */
    .btn {
      background-color: #32928E;  /* 버튼 배경색 */
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1rem;
      transition: background-color 0.3s ease;
    }

    .btn:hover {
      background-color: #267c6f;  /* 버튼 hover 상태 */
    }

     /*"출고 관리로 이동" 링크 스타일 */
    #link {
      display: inline-block;
      background-color: #32928E;
      color: #fff;
      text-decoration: none;
      padding: 10px 20px;
      border-radius: 4px;
      margin-top: 20px;
      transition: background-color 0.3s ease;
    }

    #link:hover {
      background-color: #278F75;
    }
    /* 제목과 소개글 스타일 */
    .header-container {
      margin: 20px 0;
    }

    .header-container h1 {
      color: #2c3e50;
      font-size: 2rem;
      margin-bottom: 20px;
      border-bottom: 2px solid #32928E;
      font-weight: bold;
      padding-bottom: 10px;
    }

    .header-container p {
      font-size: 16px;
      color: #7f8c8d;
    }
  </style>
</head>
<body>
<div class="grid-container">
  <!-- 헤더 -->
  <header class="layout-header">
    <div th:replace="partials/procuOneHeader :: header"></div>
  </header>

  <aside class="layout-sidebar">
    <div th:replace="partials/procuOneSide :: side"></div>
  </aside>

  <main class="layout-main">

    <!-- 제목과 소개글 -->
    <div class="header-container">
      <h1>자재출고관리</h1>
      <p>
        1. 출고 목록에서 <strong>품목</strong>을 선택합니다.<br>
        2. <strong>품목</strong>을 선택한 후, <strong>출고요청버튼</strong>을 클릭합니다.<br>
        3. 마지막으로 <strong>출고 현황</strong>과 <strong>출고 내역</strong>을 확인합니다.<br>
        <em>※ 선택기능을 사용하여 한번에 출고 요청을 할 수 있고, 생산계회별 확인 버튼을 눌러 생산 계획 목록을 확인 할 수 있습니다.</em>
      </p>
    </div>
    <button type="button" class="btn" id="toggleButton">생산계획별 확인</button>
    <section class="productionPlanListWrap"  id="planSection">
      <div class="productionPlanListSearchBar">
        <input type="text" placeholder="검색어를 입력하세요">
        <button class="searchBtn">검색</button>
        <button class="detailsBtn">등록된 계획 자세히 보기</button>
        <button onclick="updateProgress()" class="updateBtn">진행 상황 업데이트</button>
      </div>
      <h3>생산 계획 목록</h3>
      <section class="productionPlanList">
        <table>
          <thead>
          <tr>
            <th>생산 시작일</th>
            <th>생산 종료일</th>
            <th>생산계획번호</th>
            <th>생산제품명</th>
            <th>생산제품코드</th>
            <th>생산수량</th>
          </tr>
          </thead>
          <tbody id="planTableBody">
          <tr th:each="productionplan : ${productionPlanList}" onclick="highlightDates(event)">
            <td th:text="${productionplan.planStartDate}"></td>
            <td th:text="${productionplan.planEndDate}"></td>
            <td th:text="${productionplan.productPlanCode}"></td>
            <td th:text="${productionplan.productName}"></td>
            <td th:text="${productionplan.productCode}"></td>
            <td th:text="${productionplan.quantity}"></td>
          </tr>
          </tbody>
        </table>
      </section>
      <!-- 페이지네이션 -->
      <div class="pagination">
                        <span th:if="${currentProductionPlanPage > 0}">
                            <a th:href="@{/materialIssue/stockOut(page=${currentProductionPlanPage - 1})}">Previous</a>
                        </span>
        <span th:each="pageNum : ${#numbers.sequence(0, totalProductionPlanPages - 1)}">
                            <a th:href="@{/materialIssue/stockOut(page=${pageNum})}" th:text="${pageNum + 1}"
                               th:classappend="${pageNum == currentProductionPlanPage ? 'current' : ''}"></a>
                        </span>
        <span th:if="${currentProductionPlanPage < totalProductionPlanPages - 1}">
                            <a th:href="@{/materialIssue/stockOut(page=${currentProductionPlanPage + 1})}">Next</a>
                        </span>
      </div>

    </section>
  <!-- 출고 대기 현황 테이블 -->
    <!-- 출고 목록 -->
    <section>
      <h2>출고 목록</h2>
      <table>
        <thead>
        <tr>
          <th><input type="checkbox" id="selectAll" onclick="toggleAllCheckboxes(this)"> 전체 선택</th>
          <th>출고번호</th>
          <th>담당자</th>
          <th>생산계획코드</th>
          <th>조달계획코드</th>
          <th>자재코드</th>
          <th>자재명</th>
          <th>현재 수량</th>
          <th>요청 수량</th>
          <th>출고 상태</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="shipment : ${waitingShipmentList}">
          <td><input type="checkbox" name="selectItem" th:value="${shipment.shipmentId}"></td>
          <td th:text="${shipment.shipmentId}"></td>
          <td th:text="${shipment.manager}"></td>
          <td th:text="${shipment.productPlanCode}"></td>
          <td th:text="${shipment.procurementPlanCode}"></td>
          <td th:text="${shipment.productCode}"></td>
          <td th:text="${shipment.itemName}"></td>
          <td th:text="${shipment.currentQuantity}"></td>
          <td th:text="${shipment.requestedQuantity}"></td>
          <td th:text="${shipment.shipmentStatus}"></td>
        </tr>
        </tbody>
      </table>

      <!-- 페이지네이션 -->
      <div class="pagination">
    <span th:if="${currentWaitingPage > 0}">
      <a th:href="@{/materialIssue/stockOut(page=${currentWaitingPage - 1})}">이전</a>
    </span>
        <span th:each="pageNum : ${#numbers.sequence(0, totalWaitingPages - 1)}">
      <a th:href="@{/materialIssue/stockOut(page=${pageNum})}" th:text="${pageNum + 1}"
         th:classappend="${pageNum == currentWaitingPage ? 'current' : ''}"></a>
    </span>
        <span th:if="${currentWaitingPage < totalWaitingPages - 1}">
      <a th:href="@{/materialIssue/stockOut(page=${currentWaitingPage + 1})}">다음</a>
    </span>
      </div>
    </section>

    <!-- 출고 요청 버튼 -->
    <button type="button" onclick="handleOutboundRequest()" class="btn">출고 요청</button>
  <!-- 출고 현황 테이블 -->
    <section>
      <h2>출고 현황</h2>
      <table>
        <thead>
        <tr>
          <th>출고번호</th>
          <th>담당자</th>
          <th>생산계획코드</th>
          <th>조달계획코드</th>
          <th>자재코드</th>
          <th>자재명</th>
          <th>현재 수량</th>
          <th>요청 수량</th>
          <th>출고 상태</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="shipment : ${ongoingOrShortageShipmentList}">
          <td th:text="${shipment.shipmentId}"></td>
          <td th:text="${shipment.manager}"></td>
          <td th:text="${shipment.productPlanCode}"></td>
          <td th:text="${shipment.procurementPlanCode}"></td>
          <td th:text="${shipment.productCode}"></td>
          <td th:text="${shipment.itemName}"></td>
          <td th:text="${shipment.currentQuantity}"></td>
          <td th:text="${shipment.requestedQuantity}"></td>
          <td th:text="${shipment.shipmentStatus}"></td>
        </tr>
        </tbody>
      </table>

      <!-- 페이지네이션 -->
      <div class="pagination">
    <span th:if="${currentOngoingPage > 0}">
      <a th:href="@{/materialIssue/stockOut(page=${currentOngoingPage - 1})}">이전</a>
    </span>
        <span th:each="pageNum : ${#numbers.sequence(0, totalOngoingPages - 1)}">
      <a th:href="@{/materialIssue/stockOut(page=${pageNum})}" th:text="${pageNum + 1}"
         th:classappend="${pageNum == currentOngoingPage ? 'current' : ''}"></a>
    </span>
        <span th:if="${currentOngoingPage < totalOngoingPages - 1}">
      <a th:href="@{/materialIssue/stockOut(page=${currentOngoingPage + 1})}">다음</a>
    </span>
      </div>
    </section>

  <!-- 출고 내역 테이블 -->
    <section>
      <h2>출고 내역 (상태: 출고완료)</h2>
      <table>
        <thead>
        <tr>
          <th>출고번호</th>
          <th>출고일</th>
          <th>자재명</th>
          <th>요청 수량</th>
          <th>상태코드</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="shipment : ${completedShipmentList}">
          <td th:text="${shipment.shipmentId}"></td>
          <td th:text="${shipment.shipmentDate}"></td>
          <td th:text="${shipment.itemName}"></td>
          <td th:text="${shipment.requestedQuantity}"></td>
          <td th:text="${shipment.shipmentStatus}"></td>
        </tr>
        </tbody>
      </table>

      <!-- 페이지네이션 -->
      <div class="pagination">
    <span th:if="${currentCompletedPage > 0}">
      <a th:href="@{/materialIssue/stockOut(page=${currentCompletedPage - 1})}">이전</a>
    </span>
        <span th:each="pageNum : ${#numbers.sequence(0, totalCompletedPages - 1)}">
      <a th:href="@{/materialIssue/stockOut(page=${pageNum})}" th:text="${pageNum + 1}"
         th:classappend="${pageNum == currentCompletedPage ? 'current' : ''}"></a>
    </span>
        <span th:if="${currentCompletedPage < totalCompletedPages - 1}">
      <a th:href="@{/materialIssue/stockOut(page=${currentCompletedPage + 1})}">다음</a>
    </span>
      </div>
    </section>

  <a href="../materialReceipt/stockIn" id="link">입고 관리로 이동</a>
  </main>

</div>

<script>
  // 전체 선택/해제 기능
  function toggleAllCheckboxes(selectAllCheckbox) {
    const checkboxes = document.querySelectorAll('input[name="selectItem"]');
    checkboxes.forEach(checkbox => {
      checkbox.checked = selectAllCheckbox.checked;
    });
  }

  // 출고 요청 처리
  function handleOutboundRequest() {
    const selectedCheckboxes = document.querySelectorAll('input[name="selectItem"]:checked');
    if (selectedCheckboxes.length === 0) {
      alert("출고 요청할 항목을 선택해주세요.");
      return;
    }

    const selectedShipments = [];
    selectedCheckboxes.forEach(checkbox => {
      const row = checkbox.closest('tr'); // 현재 행
      const shipmentId = row.cells[1].textContent; // 출고번호
      const productName = row.cells[6].textContent; // 자재명
      const requestedQuantity = row.cells[8].textContent; // 요청 수량
      const shipmentStatus = row.cells[9].textContent; // 출고 상태

      // 선택된 출고 항목 데이터 수집
      selectedShipments.push({
        shipmentId,
        productName,
        requestedQuantity,
        shipmentStatus,
      });
    });
    const selectedShipmentIds = selectedShipments.map(shipment => shipment.shipmentId);

    fetch('/materialIssue/stockOut', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ shipments: selectedShipmentIds }),
    })
            .then(response => {
              if (!response.ok) {
                throw new Error('출고 요청 처리 중 오류가 발생했습니다.');
              }
              return response.text();
            })
            .then(message => {
              alert(message); // 성공 메시지 출력
              alert(`${selectedShipments.length}개의 출고 요청이 완료되었습니다.`);
              location.reload(); // 페이지 새로고침
            })
            .catch(error => {
              console.error('출고 요청 처리 중 오류:', error);
              alert('출고 요청 처리 중 오류가 발생했습니다.');
            });

    // 선택된 항목 출력 (백엔드 연동 시 이 부분을 서버 전송 로직으로 변경)
    console.log("출고 요청 항목:", selectedShipments);


    // 여기에 서버로 데이터를 전송하는 AJAX 또는 폼 제출 로직을 추가 가능
  }

  // 버튼 클릭 시 섹션 애니메이션 효과로 숨기기/보이기
  document.getElementById("toggleButton").addEventListener("click", function() {
    const planSection = document.getElementById("planSection");
    planSection.classList.toggle("active");
  });
</script>

</body>
</html>
