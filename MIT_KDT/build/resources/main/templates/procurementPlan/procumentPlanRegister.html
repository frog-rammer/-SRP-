<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>조달계획 등록 페이지</title>
  <link rel="stylesheet" th:href="@{/css/procuOneHeader.css}">
  <link rel="stylesheet" th:href="@{/css/layout.css}">
  <style>
    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
      text-align: center;
      margin: 20px 0;
    }

    .calendar div {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      cursor: pointer;
    }

    .calendar .highlight {
      background-color: #0078a0;
      color: white;
    }

    .calendar .disabled {
      background-color: #f5f5f5;
      color: #999;
      pointer-events: none; /* 클릭 비활성화 */
      cursor: not-allowed; /* 클릭 불가능한 커서 표시 */
    }

    .calendar .label {
      font-size: 12px;
      margin-top: 5px;
      display: block;
    }

    .form-container {
      margin-top: 20px;
    }
  </style>
</head>
<body>
<div class="grid-container">
  <header class="layout-header">
    <div th:replace="partials/procuOneHeader :: header"></div>
  </header>
  <aside class="layout-sidebar">
    <div th:replace="partials/procuOneSide :: side"></div>
  </aside>
  <main class="layout-main">
    <!-- 생산 계획 목록 -->
    <section class="productionPlanListWrap">
      <div class="productionPlanListSearchBar">
        <input type="text" placeholder="검색어를 입력하세요">
        <button class="searchBtn">검색</button>
        <button class="detailsBtn">등록된 계획 자세히 보기</button>
        <button onclick="updateProgress()">진행 상황 업데이트</button>
      </div>
      <h3>생산 계획 목록</h3>
      <section class="productionPlanList">
        <table>
          <thead>
          <tr>
            <th>생산 시작일</th>
            <th>생산 종료일</th>
            <th>생산계획번호</th>
            <th>생산제품명</th>
            <th>생산제품코드</th>
            <th>생산수량</th>
          </tr>
          </thead>
          <tbody>
          <tr th:each="productionPlan : ${productionPlanList}"
              th:attr="data-start-date=${productionPlan.planStartDate}, data-end-date=${productionPlan.planEndDate},
                        data-product-name=${productionPlan.productName}, data-product-code=${productionPlan.productCode},
                        data-quantity=${productionPlan.quantity}"
              onclick="onProductionPlanClick(this)">
            <td th:text="${productionPlan.planStartDate}"></td>
            <td th:text="${productionPlan.planEndDate}"></td>
            <td th:text="${productionPlan.productPlanCode}"></td>
            <td th:text="${productionPlan.productName}"></td>
            <td th:text="${productionPlan.productCode}"></td>
            <td th:text="${productionPlan.quantity}"></td>
          </tr>

          <tr th:if="${#lists.isEmpty(productionPlanList)}">
            <td colspan="6">등록된 생산 계획이 없습니다.</td>
          </tr>
          </tbody>
        </table>
        <div class="pagination">
          <ul>
            <li th:if="${currentPage > 0}">
              <a th:href="@{'/procumentPlan/register'(page=${currentPage - 1}, size=10)}">&laquo; 이전</a>
            </li>
            <li th:each="pageNumber : ${#numbers.sequence(startPage, endPage)}"
                th:classappend="${pageNumber - 1 == currentPage} ? 'active'">
              <a th:href="@{'/procumentPlan/register'(page=${pageNumber - 1}, size=10)}" th:text="${pageNumber}">1</a>
            </li>
            <li th:if="${currentPage + 1 < totalPages}">
              <a th:href="@{'/procumentPlan/register'(page=${currentPage + 1}, size=10)}">다음 &raquo;</a>
            </li>
          </ul>
        </div>
      </section>
    </section>

    <!-- 캘린더 -->

    <div>
      <h4>조달 납기일 선정</h4>
      <select id="yearSelect"></select>
      <select id="monthSelect">
        <option value="0">1월</option>
        <option value="1">2월</option>
        <option value="2">3월</option>
        <option value="3">4월</option>
        <option value="4">5월</option>
        <option value="5">6월</option>
        <option value="6">7월</option>
        <option value="7">8월</option>
        <option value="8">9월</option>
        <option value="9">10월</option>
        <option value="10">11월</option>
        <option value="11">12월</option>
      </select>
    </div>
    <div id="calendar" class="calendar"></div>

    <!-- 조달계획 등록 폼 -->
    <h1>조달계획등록</h1>
    <div class="form-container">
      <form action="/submitProcurementPlan" method="POST">
        <table>
          <tr>
            <th>생산 시작일</th>
            <td><input type="text" id="startDate" name="startDate" readonly></td>
          </tr>
          <tr>
            <th>생산 종료일</th>
            <td><input type="text" id="endDate" name="endDate" readonly></td>
          </tr>
          <tr>
            <th>생산제품명</th>
            <td><input type="text" id="productName" name="productName" readonly></td>
          </tr>
          <tr>
            <th>생산제품코드</th>
            <td><input type="text" id="productCode" name="productCode" readonly></td>
          </tr>
          <tr>
            <th>생산 예정 수량</th>
            <td><input type="text" id="quantity" name="quantity" readonly></td>
          </tr>
          <tr>
            <th>조달 수량</th>
            <td><input type="text" id="procumentQuntity" name="procumentQuntity"></td>
          </tr>
          <tr>
            <th>조달 납기일</th>
            <td><input type="date" id="procurementDate" name="procurementDate" required></td>
          </tr>
        </table>
        <div class="form-actions">
          <button type="submit">조달계획 등록</button>
        </div>
      </form>
    </div>
  </main>
  <footer class="layout-footer"></footer>
</div>
<script>
  const yearSelect = document.getElementById('yearSelect');
  const monthSelect = document.getElementById('monthSelect');
  const calendar = document.getElementById('calendar');
  const procurementDateInput = document.getElementById('procurementDate');
  const startDateInput = document.getElementById('startDate');
  const endDateInput = document.getElementById('endDate');
  const productNameInput = document.getElementById('productName');
  const productCodeInput = document.getElementById('productCode');
  const quantityInput = document.getElementById('quantity');

  let productionStartDate, productionEndDate;

  for (let i = 2020; i <= 2030; i++) {
    const option = document.createElement('option');
    option.value = i;
    option.textContent = i;
    yearSelect.appendChild(option);
  }
  yearSelect.value = new Date().getFullYear();
  monthSelect.value = new Date().getMonth();

  function renderCalendar(year, month) {
    const firstDay = new Date(year, month, 1).getDay();
    const lastDate = new Date(year, month + 1, 0).getDate();
    calendar.innerHTML = '<div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>';

    for (let i = 0; i < firstDay; i++) {
      calendar.innerHTML += '<div></div>';
    }

    for (let i = 1; i <= lastDate; i++) {
      const dateDiv = document.createElement('div');
      const currentDate = new Date(year, month, i);
      currentDate.setHours(0, 0, 0, 0);

      dateDiv.innerHTML = `<span>${i}</span>`;

      // 기존 "조달 납기일" 텍스트 제거
      dateDiv.onclick = () => {
        document.querySelectorAll('.calendar .label').forEach(label => label.remove()); // 모든 "조달 납기일" 제거
        const localDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), currentDate.getDate());
        procurementDateInput.value = `${localDate.getFullYear()}-${String(localDate.getMonth() + 1).padStart(2, '0')}-${String(localDate.getDate()).padStart(2, '0')}`;
        dateDiv.innerHTML += '<div class="label">조달 납기일</div>';
      };

      // 생산 시작일 이후 비활성화
      if (productionStartDate && currentDate.getTime() >= productionStartDate.getTime()) {
        dateDiv.classList.add('disabled');
        dateDiv.style.pointerEvents = 'none';
      }

      // 생산 시작일 표시
      if (productionStartDate && currentDate.getTime() === productionStartDate.getTime()) {
        dateDiv.classList.add('highlight');
        dateDiv.innerHTML += '<div>생산 시작일</div>';
      }

      // 생산 종료일 표시
      if (productionEndDate && currentDate.getTime() === productionEndDate.getTime()) {
        dateDiv.classList.add('highlight');
        dateDiv.innerHTML += '<div>생산 종료일</div>';
      }

      calendar.appendChild(dateDiv);
    }
  }

  renderCalendar(yearSelect.value, monthSelect.value);

  yearSelect.addEventListener('change', () => {
    renderCalendar(parseInt(yearSelect.value), parseInt(monthSelect.value));
  });

  monthSelect.addEventListener('change', () => {
    renderCalendar(parseInt(yearSelect.value), parseInt(monthSelect.value));
  });

  function onProductionPlanClick(row) {
    const startDate = row.getAttribute('data-start-date');
    const endDate = row.getAttribute('data-end-date');
    const productName = row.getAttribute('data-product-name');
    const productCode = row.getAttribute('data-product-code');
    const quantity = row.getAttribute('data-quantity');

    productionStartDate = new Date(startDate);
    productionEndDate = new Date(endDate);

    startDateInput.value = startDate;
    endDateInput.value = endDate;
    productNameInput.value = productName;
    productCodeInput.value = productCode;
    quantityInput.value = quantity;

    yearSelect.value = productionStartDate.getFullYear();
    monthSelect.value = productionStartDate.getMonth();

    renderCalendar(productionStartDate.getFullYear(), productionStartDate.getMonth());
  }
</script>
</body>
</html>
